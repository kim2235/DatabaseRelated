#全家(FamilyMart)“全民抓拍雞腿”活動數據分組匯總


今天全家(FamilyMart)進行“全民抓拍雞腿”活動，後端代碼及圖片辨識過程由公司承接，活動開始後，大量數據進入數據庫。而作爲公司DBA的擎天節度趁機對數據進行了一些匯總，期間大量使用到MariaDB時間函數。


1. [統計活動期間辨識人次和辨識人數](#統計活動期間辨識人次和辨識人數)
2. [統計活動期間各個小時內的辨識人次和辨識人數](#統計活動期間各個小時內的辨識人次和辨識人數)
3. [統計活動期間每分鐘的辨識人次和辨識人數](#統計活動期間每分鐘的辨識人次和辨識人數)
4. [統計活動期間每小時內每分鐘的辨識人次和辨識人數](#統計活動期間每小時內每分鐘的辨識人次和辨識人數)
5. [統計活動期間每小時內同一分鐘的辨識人次和辨識人數](#統計活動期間每小時內同一分鐘的辨識人次和辨識人數)
6. [統計活動期間某一分鐘的辨識人次和辨識人數](#統計活動期間某一分鐘的辨識人次和辨識人數)
7. [活動期間圖片辨識情況統計](#活動期間圖片辨識情況統計)
8. [活動期間具體某一小時內圖片辨識情況統計](#活動期間具體某一小時內圖片辨識情況統計)
9. [活動期間具體某一小時某一分鐘內圖片辨識情況統計](#活動期間具體某一小時某一分鐘內圖片辨識情況統計)
10. [活動期間辨識成功率](#活動期間辨識成功率)
11. [圖片辨識耗時](#圖片辨識耗時)
12. [參考資料](#參考資料)

---

以下是從全家的官方微博截取的圖片：

![](./images/2015/09/2015-09-29_101451.png)

![](./images/2015/09/2015-09-29_101532.png)

![](./images/2015/09/2015-09-29_101602.png)

![](./images/2015/09/2015-09-29_101624.png)

---
整個活動持續時間是`2015.09.29 08:00 ~ 20:00`，
該活動數據以`web_token`區分，全家的shop_name是`familymart`
數據入庫時間以10位時間戳形式存入，記錄有用戶IP
以表`match_history`中自增id作爲辨識次數，以ip去重複作爲辨識人數（不準確，以`web_token`形式進來）


####統計活動期間辨識人次和辨識人數
```sql
MariaDB [isnapp]> select now() as '當前時間', count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart';
+---------------------+--------------+--------------+
| 當前時間            | 辨識人次     | 辨識人數     |
+---------------------+--------------+--------------+
| 2015-10-08 12:07:20 |       235520 |        14113 |
+---------------------+--------------+--------------+
1 row in set (1.06 sec)

MariaDB [isnapp]>
```

---

####統計活動期間各個小時內的辨識人次和辨識人數
**`使用IFNULL時，出現問題`**

```sql
MariaDB [isnapp]> select now() as '當前時間', HOUR(FROM_UNIXTIME(a.create_time)) as '小時數',count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart' group by 小時數 desc with rollup;
+---------------------+-----------+--------------+--------------+
| 當前時間            | 小時數    | 辨識人次     | 辨識人數     |
+---------------------+-----------+--------------+--------------+
| 2015-10-08 12:07:43 |        20 |           99 |           85 |
| 2015-10-08 12:07:43 |        19 |        18755 |         3875 |
| 2015-10-08 12:07:43 |        18 |        13377 |         3211 |
| 2015-10-08 12:07:43 |        17 |        12761 |         2432 |
| 2015-10-08 12:07:43 |        16 |        16756 |         2063 |
| 2015-10-08 12:07:43 |        15 |        17746 |         2202 |
| 2015-10-08 12:07:43 |        14 |        18106 |         2191 |
| 2015-10-08 12:07:43 |        13 |        19295 |         2228 |
| 2015-10-08 12:07:43 |        12 |        23501 |         2554 |
| 2015-10-08 12:07:43 |        11 |        28005 |         2693 |
| 2015-10-08 12:07:43 |        10 |        37048 |         2798 |
| 2015-10-08 12:07:43 |         9 |        15384 |         2368 |
| 2015-10-08 12:07:43 |         8 |        14687 |         2051 |
| 2015-10-08 12:07:43 |      NULL |       235520 |        14113 |
+---------------------+-----------+--------------+--------------+
14 rows in set (1.95 sec)

MariaDB [isnapp]> 

//加上IFNULL，無法得到預計的數據格式
MariaDB [isnapp]> select now() as '當前時間', IFNULL(HOUR(FROM_UNIXTIME(a.create_time)),'總計') as '小時數',count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart' group by 小時數 desc with rollup;
+---------------------+-----------+--------------+--------------+
| 當前時間            | 小時數    | 辨識人次     | 辨識人數     |
+---------------------+-----------+--------------+--------------+
| 2015-10-08 12:08:17 | 9         |        15384 |         2368 |
| 2015-10-08 12:08:17 | 8         |        14687 |         2051 |
| 2015-10-08 12:08:17 | 20        |           99 |           85 |
| 2015-10-08 12:08:17 | 19        |        18755 |         3875 |
| 2015-10-08 12:08:17 | 18        |        13377 |         3211 |
| 2015-10-08 12:08:17 | 17        |        12761 |         2432 |
| 2015-10-08 12:08:17 | 16        |        16756 |         2063 |
| 2015-10-08 12:08:17 | 15        |        17746 |         2202 |
| 2015-10-08 12:08:17 | 14        |        18106 |         2191 |
| 2015-10-08 12:08:17 | 13        |        19295 |         2228 |
| 2015-10-08 12:08:17 | 12        |        23501 |         2554 |
| 2015-10-08 12:08:17 | 11        |        28005 |         2693 |
| 2015-10-08 12:08:17 | 10        |        37048 |         2798 |
| 2015-10-08 12:08:17 | NULL      |       235520 |        14113 |
+---------------------+-----------+--------------+--------------+
14 rows in set (1.95 sec)

MariaDB [isnapp]>
```

---
####統計活動期間每分鐘的辨識人次和辨識人數

```sql
MariaDB [isnapp]> select now() as '當前時間', HOUR(FROM_UNIXTIME(a.create_time)) as '小時',MINUTE(FROM_UNIXTIME(a.create_time)) as '分鐘',count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart' group by 小時 desc,分鐘 desc;
+---------------------+--------+--------+--------------+--------------+
| 當前時間            | 小時   | 分鐘   | 辨識人次     | 辨識人數     |
+---------------------+--------+--------+--------------+--------------+
| 2015-10-08 12:08:41 |     20 |      0 |           99 |           85 |
| 2015-10-08 12:08:41 |     19 |     59 |         1682 |          508 |
| 2015-10-08 12:08:41 |     19 |     58 |          742 |          267 |
| 2015-10-08 12:08:41 |     19 |     57 |          627 |          236 |
| 2015-10-08 12:08:41 |     19 |     56 |          458 |          189 |
| 2015-10-08 12:08:41 |     19 |     55 |          373 |          162 |
| 2015-10-08 12:08:41 |     19 |     54 |          357 |          162 |
| 2015-10-08 12:08:41 |     19 |     53 |          354 |          133 |
| 2015-10-08 12:08:41 |     19 |     52 |          258 |          128 |
| 2015-10-08 12:08:41 |     19 |     51 |          245 |          103 |
| 2015-10-08 12:08:41 |     19 |     50 |          225 |           81 |
| 2015-10-08 12:08:41 |     19 |     49 |          175 |           84 |
| 2015-10-08 12:08:41 |     19 |     48 |          135 |           77 |
| 2015-10-08 12:08:41 |     19 |     47 |          142 |           79 |
                       ......
| 2015-10-08 12:08:41 |      8 |     16 |          351 |          145 |
| 2015-10-08 12:08:41 |      8 |     15 |          349 |          153 |
| 2015-10-08 12:08:41 |      8 |     14 |          348 |          129 |
| 2015-10-08 12:08:41 |      8 |     13 |          349 |          139 |
| 2015-10-08 12:08:41 |      8 |     12 |          397 |          169 |
| 2015-10-08 12:08:41 |      8 |     11 |          422 |          156 |
| 2015-10-08 12:08:41 |      8 |     10 |          493 |          188 |
| 2015-10-08 12:08:41 |      8 |      9 |          466 |          167 |
| 2015-10-08 12:08:41 |      8 |      8 |          464 |          164 |
| 2015-10-08 12:08:41 |      8 |      7 |          442 |          162 |
| 2015-10-08 12:08:41 |      8 |      6 |          476 |          178 |
| 2015-10-08 12:08:41 |      8 |      5 |          452 |          173 |
| 2015-10-08 12:08:41 |      8 |      4 |          496 |          187 |
| 2015-10-08 12:08:41 |      8 |      3 |          604 |          223 |
| 2015-10-08 12:08:41 |      8 |      2 |          653 |          219 |
| 2015-10-08 12:08:41 |      8 |      1 |          682 |          237 |
| 2015-10-08 12:08:41 |      8 |      0 |          770 |          293 |
+---------------------+--------+--------+--------------+--------------+
721 rows in set (1.91 sec)

MariaDB [isnapp]>
```

---
####統計活動期間每小時內每分鐘的辨識人次和辨識人數
```sql
//SQL語句where中的11可以更換成其它小時數
MariaDB [isnapp]> select now() as '當前時間', HOUR(FROM_UNIXTIME(a.create_time)) as '小時',MINUTE(FROM_UNIXTIME(a.create_time)) as '分鐘',count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart' and HOUR(FROM_UNIXTIME(a.create_time))=11 group by 小時 desc,分鐘 desc;
+---------------------+--------+--------+--------------+--------------+
| 當前時間            | 小時   | 分鐘   | 辨識人次     | 辨識人數     |
+---------------------+--------+--------+--------------+--------------+
| 2015-09-29 18:12:24 |     11 |     59 |         1846 |          402 |
| 2015-09-29 18:12:24 |     11 |     58 |          696 |          202 |
| 2015-09-29 18:12:24 |     11 |     57 |          522 |          163 |
| 2015-09-29 18:12:24 |     11 |     56 |          428 |          130 |
| 2015-09-29 18:12:24 |     11 |     55 |          366 |          110 |
| 2015-09-29 18:12:24 |     11 |     54 |          305 |          104 |
| 2015-09-29 18:12:24 |     11 |     53 |          258 |           81 |
| 2015-09-29 18:12:24 |     11 |     52 |          274 |          105 |
| 2015-09-29 18:12:24 |     11 |     51 |          264 |           92 |
| 2015-09-29 18:12:24 |     11 |     50 |          234 |           79 |
| 2015-09-29 18:12:24 |     11 |     49 |          263 |           80 |
| 2015-09-29 18:12:24 |     11 |     48 |          247 |           75 |
| 2015-09-29 18:12:24 |     11 |     47 |          196 |           67 |
| 2015-09-29 18:12:24 |     11 |     46 |          196 |           66 |
| 2015-09-29 18:12:24 |     11 |     45 |          190 |           73 |
| 2015-09-29 18:12:24 |     11 |     44 |          221 |           84 |
| 2015-09-29 18:12:24 |     11 |     43 |          239 |           80 |
| 2015-09-29 18:12:24 |     11 |     42 |          225 |           88 |
| 2015-09-29 18:12:24 |     11 |     41 |          207 |           82 |
| 2015-09-29 18:12:24 |     11 |     40 |          181 |           66 |
| 2015-09-29 18:12:24 |     11 |     39 |          195 |           83 |
| 2015-09-29 18:12:24 |     11 |     38 |          187 |           76 |
| 2015-09-29 18:12:24 |     11 |     37 |          197 |           65 |
| 2015-09-29 18:12:24 |     11 |     36 |          180 |           64 |
| 2015-09-29 18:12:24 |     11 |     35 |          215 |           80 |
| 2015-09-29 18:12:24 |     11 |     34 |          188 |           78 |
| 2015-09-29 18:12:24 |     11 |     33 |          194 |           72 |
| 2015-09-29 18:12:24 |     11 |     32 |          221 |           74 |
| 2015-09-29 18:12:24 |     11 |     31 |          186 |           76 |
| 2015-09-29 18:12:24 |     11 |     30 |          222 |           91 |
| 2015-09-29 18:12:24 |     11 |     29 |          249 |           96 |
| 2015-09-29 18:12:24 |     11 |     28 |          255 |           86 |
| 2015-09-29 18:12:24 |     11 |     27 |          276 |           96 |
| 2015-09-29 18:12:24 |     11 |     26 |          262 |           92 |
| 2015-09-29 18:12:24 |     11 |     25 |          274 |          107 |
| 2015-09-29 18:12:24 |     11 |     24 |          296 |           93 |
| 2015-09-29 18:12:24 |     11 |     23 |          290 |           93 |
| 2015-09-29 18:12:24 |     11 |     22 |          313 |          103 |
| 2015-09-29 18:12:24 |     11 |     21 |          342 |          114 |
| 2015-09-29 18:12:24 |     11 |     20 |          290 |          100 |
| 2015-09-29 18:12:24 |     11 |     19 |          309 |           92 |
| 2015-09-29 18:12:24 |     11 |     18 |          318 |           89 |
| 2015-09-29 18:12:24 |     11 |     17 |          373 |          126 |
| 2015-09-29 18:12:24 |     11 |     16 |          367 |          142 |
| 2015-09-29 18:12:24 |     11 |     15 |          359 |          131 |
| 2015-09-29 18:12:24 |     11 |     14 |          365 |          151 |
| 2015-09-29 18:12:24 |     11 |     13 |          454 |          159 |
| 2015-09-29 18:12:24 |     11 |     12 |          389 |          147 |
| 2015-09-29 18:12:24 |     11 |     11 |          468 |          164 |
| 2015-09-29 18:12:24 |     11 |     10 |          505 |          158 |
| 2015-09-29 18:12:24 |     11 |      9 |          425 |          172 |
| 2015-09-29 18:12:24 |     11 |      8 |          538 |          171 |
| 2015-09-29 18:12:24 |     11 |      7 |          559 |          184 |
| 2015-09-29 18:12:24 |     11 |      6 |          718 |          264 |
| 2015-09-29 18:12:24 |     11 |      5 |         1675 |          388 |
| 2015-09-29 18:12:24 |     11 |      4 |         1881 |          383 |
| 2015-09-29 18:12:24 |     11 |      3 |         1269 |          332 |
| 2015-09-29 18:12:24 |     11 |      2 |          975 |          302 |
| 2015-09-29 18:12:24 |     11 |      1 |         1180 |          423 |
| 2015-09-29 18:12:24 |     11 |      0 |         2688 |          890 |
+---------------------+--------+--------+--------------+--------------+
60 rows in set (0.54 sec)

MariaDB [isnapp]>
```

---
####統計活動期間每小時內同一分鐘的辨識人次和辨識人數
```sql
//SQL語句where中的0可以替換爲[0,59]中任意整數
MariaDB [isnapp]> select now() as '當前時間', HOUR(FROM_UNIXTIME(a.create_time)) as '小時',MINUTE(FROM_UNIXTIME(a.create_time)) as '分鐘',count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart' and MINUTE(FROM_UNIXTIME(a.create_time))=0 group by 小時 desc,分鐘 desc; 
+---------------------+--------+--------+--------------+--------------+
| 當前時間            | 小時   | 分鐘   | 辨識人次     | 辨識人數     |
+---------------------+--------+--------+--------------+--------------+
| 2015-10-08 12:10:23 |     20 |      0 |           99 |           85 |
| 2015-10-08 12:10:23 |     19 |      0 |         2399 |         1255 |
| 2015-10-08 12:10:23 |     18 |      0 |         1168 |          809 |
| 2015-10-08 12:10:23 |     17 |      0 |         2774 |          825 |
| 2015-10-08 12:10:23 |     16 |      0 |         3103 |          904 |
| 2015-10-08 12:10:23 |     15 |      0 |         3017 |          932 |
| 2015-10-08 12:10:23 |     14 |      0 |         3196 |          896 |
| 2015-10-08 12:10:23 |     13 |      0 |         2957 |          879 |
| 2015-10-08 12:10:23 |     12 |      0 |         3535 |          912 |
| 2015-10-08 12:10:23 |     11 |      0 |         2688 |          890 |
| 2015-10-08 12:10:23 |     10 |      0 |         2415 |          799 |
| 2015-10-08 12:10:23 |      9 |      0 |          987 |          351 |
| 2015-10-08 12:10:23 |      8 |      0 |          770 |          293 |
+---------------------+--------+--------+--------------+--------------+
13 rows in set (0.63 sec)

MariaDB [isnapp]>
```

---
####統計活動期間某一分鐘的辨識人次和辨識人數

```sql
//SQL語句where中的12(小時)和0(分鐘)可以替換其它數據
MariaDB [isnapp]> select now() as '當前時間', HOUR(FROM_UNIXTIME(a.create_time)) as '小時',MINUTE(FROM_UNIXTIME(a.create_time)) as '分鐘',SECOND(FROM_UNIXTIME(a.create_time)) as '秒',count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart' and HOUR(FROM_UNIXTIME(a.create_time))=12 and MINUTE(FROM_UNIXTIME(a.create_time))=0 group by 小時 desc,分鐘 desc,秒 desc;
+---------------------+--------+--------+------+--------------+--------------+
| 當前時間            | 小時   | 分鐘   | 秒   | 辨識人次     | 辨識人數     |
+---------------------+--------+--------+------+--------------+--------------+
| 2015-09-29 18:13:15 |     12 |      0 |   59 |           47 |           26 |
| 2015-09-29 18:13:15 |     12 |      0 |   58 |           37 |           15 |
| 2015-09-29 18:13:15 |     12 |      0 |   57 |           22 |            8 |
| 2015-09-29 18:13:15 |     12 |      0 |   56 |           39 |           18 |
| 2015-09-29 18:13:15 |     12 |      0 |   55 |           31 |           22 |
| 2015-09-29 18:13:15 |     12 |      0 |   54 |           34 |           23 |
| 2015-09-29 18:13:15 |     12 |      0 |   53 |           47 |           31 |
| 2015-09-29 18:13:15 |     12 |      0 |   52 |           44 |           18 |
| 2015-09-29 18:13:15 |     12 |      0 |   51 |           29 |           14 |
| 2015-09-29 18:13:15 |     12 |      0 |   50 |           32 |           17 |
| 2015-09-29 18:13:15 |     12 |      0 |   49 |           45 |           25 |
| 2015-09-29 18:13:15 |     12 |      0 |   48 |           21 |           10 |
| 2015-09-29 18:13:15 |     12 |      0 |   47 |           38 |           21 |
| 2015-09-29 18:13:15 |     12 |      0 |   46 |           50 |           31 |
| 2015-09-29 18:13:15 |     12 |      0 |   45 |           45 |           26 |
| 2015-09-29 18:13:15 |     12 |      0 |   44 |           22 |           15 |
| 2015-09-29 18:13:15 |     12 |      0 |   43 |           40 |           23 |
| 2015-09-29 18:13:15 |     12 |      0 |   42 |           37 |           24 |
| 2015-09-29 18:13:15 |     12 |      0 |   41 |           35 |           14 |
| 2015-09-29 18:13:15 |     12 |      0 |   40 |           34 |           21 |
| 2015-09-29 18:13:15 |     12 |      0 |   39 |           37 |           25 |
| 2015-09-29 18:13:15 |     12 |      0 |   38 |           39 |           20 |
| 2015-09-29 18:13:15 |     12 |      0 |   37 |           36 |           14 |
| 2015-09-29 18:13:15 |     12 |      0 |   36 |           42 |           23 |
| 2015-09-29 18:13:15 |     12 |      0 |   35 |           33 |           14 |
| 2015-09-29 18:13:15 |     12 |      0 |   34 |           42 |           19 |
| 2015-09-29 18:13:15 |     12 |      0 |   33 |           35 |           21 |
| 2015-09-29 18:13:15 |     12 |      0 |   32 |           37 |           23 |
| 2015-09-29 18:13:15 |     12 |      0 |   31 |           54 |           26 |
| 2015-09-29 18:13:15 |     12 |      0 |   30 |           26 |            8 |
| 2015-09-29 18:13:15 |     12 |      0 |   29 |           46 |           26 |
| 2015-09-29 18:13:15 |     12 |      0 |   28 |           41 |           19 |
| 2015-09-29 18:13:15 |     12 |      0 |   27 |           45 |           19 |
| 2015-09-29 18:13:15 |     12 |      0 |   26 |           33 |           19 |
| 2015-09-29 18:13:15 |     12 |      0 |   25 |           44 |           26 |
| 2015-09-29 18:13:15 |     12 |      0 |   24 |           46 |           20 |
| 2015-09-29 18:13:15 |     12 |      0 |   23 |           53 |           32 |
| 2015-09-29 18:13:15 |     12 |      0 |   22 |           47 |           25 |
| 2015-09-29 18:13:15 |     12 |      0 |   21 |           67 |           25 |
| 2015-09-29 18:13:15 |     12 |      0 |   20 |           76 |           32 |
| 2015-09-29 18:13:15 |     12 |      0 |   19 |           73 |           34 |
| 2015-09-29 18:13:15 |     12 |      0 |   18 |           56 |           31 |
| 2015-09-29 18:13:15 |     12 |      0 |   17 |           67 |           51 |
| 2015-09-29 18:13:15 |     12 |      0 |   16 |           42 |           23 |
| 2015-09-29 18:13:15 |     12 |      0 |   15 |           50 |           28 |
| 2015-09-29 18:13:15 |     12 |      0 |   14 |           70 |           31 |
| 2015-09-29 18:13:15 |     12 |      0 |   13 |           87 |           33 |
| 2015-09-29 18:13:15 |     12 |      0 |   12 |          119 |           49 |
| 2015-09-29 18:13:15 |     12 |      0 |   11 |          100 |           31 |
| 2015-09-29 18:13:15 |     12 |      0 |   10 |          115 |           32 |
| 2015-09-29 18:13:15 |     12 |      0 |    9 |          128 |           49 |
| 2015-09-29 18:13:15 |     12 |      0 |    8 |          126 |           39 |
| 2015-09-29 18:13:15 |     12 |      0 |    7 |          135 |           53 |
| 2015-09-29 18:13:15 |     12 |      0 |    6 |          120 |           61 |
| 2015-09-29 18:13:15 |     12 |      0 |    5 |          130 |           65 |
| 2015-09-29 18:13:15 |     12 |      0 |    4 |          136 |           65 |
| 2015-09-29 18:13:15 |     12 |      0 |    3 |          124 |           71 |
| 2015-09-29 18:13:15 |     12 |      0 |    2 |          114 |           77 |
| 2015-09-29 18:13:15 |     12 |      0 |    1 |           80 |           49 |
| 2015-09-29 18:13:15 |     12 |      0 |    0 |           55 |           33 |
+---------------------+--------+--------+------+--------------+--------------+
60 rows in set (0.41 sec)

MariaDB [isnapp]>
```

---
####活動期間圖片辨識情況統計
```sql
MariaDB [isnapp]> select now() as '當前時間',case a.status when 0 then '未辨識' when 1 then 'REC' when 2 then 'HRS' when 3 then '辨識失敗' else '其它' end status,count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart' group by status;
+---------------------+--------------+--------------+--------------+
| 當前時間            | status       | 辨識人次     | 辨識人數     |
+---------------------+--------------+--------------+--------------+
| 2015-10-08 12:10:57 | HRS          |         8090 |         1871 |
| 2015-10-08 12:10:57 | REC          |       119601 |        10163 |
| 2015-10-08 12:10:57 | 其它         |        75295 |         5714 |
| 2015-10-08 12:10:57 | 未辨識       |        21491 |         1953 |
| 2015-10-08 12:10:57 | 辨識失敗     |        11043 |         1145 |
+---------------------+--------------+--------------+--------------+
5 rows in set (1.22 sec)

MariaDB [isnapp]>
```

---
####活動期間具體某一小時內圖片辨識情況統計
```sql
//SQL語句where中的11可以替換爲[8,20]中任意整數
MariaDB [isnapp]> select now() as '當前時間',case a.status when 0 then '未辨識' when 1 then 'REC' when 2 then 'HRS' when 3 then '辨識失敗' else '其它' end status,count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart' and HOUR(FROM_UNIXTIME(a.create_time))=11 group by status;
+---------------------+--------------+--------------+--------------+
| 當前時間            | status       | 辨識人次     | 辨識人數     |
+---------------------+--------------+--------------+--------------+
| 2015-09-29 18:14:24 | HRS          |          279 |           85 |
| 2015-09-29 18:14:24 | REC          |        13805 |         1991 |
| 2015-09-29 18:14:24 | 其它         |         5105 |          680 |
| 2015-09-29 18:14:24 | 未辨識       |            8 |            7 |
| 2015-09-29 18:14:24 | 辨識失敗     |         8808 |          852 |
+---------------------+--------------+--------------+--------------+
5 rows in set (0.52 sec)

MariaDB [isnapp]>
```

---
####活動期間具體某一小時某一分鐘內圖片辨識情況統計
```sql
//SQL語句where中的11(小時)和0(分鐘)可以替換其它數據
MariaDB [isnapp]> select now() as '當前時間',case a.status when 0 then '未辨識' when 1 then 'REC' when 2 then 'HRS' when 3 then '辨識失敗' else '其它' end status,count(a.id) as '辨識人次', count(distinct(a.ip)) as '辨識人數' from match_history a join web_token b on a.web_token=b.token where a.create_time between UNIX_TIMESTAMP('2015-09-29 08:00:00') and UNIX_TIMESTAMP('2015-09-29 20:00:00') and b.shop_name='familymart' and HOUR(FROM_UNIXTIME(a.create_time))=11 and MINUTE(FROM_UNIXTIME(a.create_time))=0 group by status; 
+---------------------+--------------+--------------+--------------+
| 當前時間            | status       | 辨識人次     | 辨識人數     |
+---------------------+--------------+--------------+--------------+
| 2015-09-29 18:14:43 | HRS          |           15 |            4 |
| 2015-09-29 18:14:43 | REC          |         2092 |          771 |
| 2015-09-29 18:14:43 | 其它         |          385 |          114 |
| 2015-09-29 18:14:43 | 辨識失敗     |          196 |           69 |
+---------------------+--------------+--------------+--------------+
4 rows in set (0.48 sec)

MariaDB [isnapp]>
```

---
####活動期間辨識成功率
```sql
//暫時還沒想到直接使用SQL語句實現的方法，可以通過PHP等語言將獲取到的分組信息進行計算得到成功率
```

---
####圖片辨識耗時
```sql
//需要用到MariaDB數學函數
```

---
####參考資料
[Date and Time Functions](https://mariadb.com/kb/en/mariadb/date-and-time-functions/)
[BETWEEN AND](https://mariadb.com/kb/en/mariadb/between-and/)
[MARIADB: BETWEEN CONDITION](http://www.techonthenet.com/mariadb/between.php)
[UNIX_TIMESTAMP](UNIX_TIMESTAMP)
[FROM_UNIXTIME](https://mariadb.com/kb/en/mariadb/from_unixtime/)
[NOW](https://mariadb.com/kb/en/mariadb/now/)
[SELECT WITH ROLLUP](https://mariadb.com/kb/en/mariadb/select-with-rollup/)
[New Syntax](https://mariadb.com/kb/en/sql-99/new-syntax/)
[Using GROUP BY WITH ROLLUP for Reporting Performance Optimization IFNULL](https://www.percona.com/blog/2007/09/17/using-group-by-with-rollup-for-reporting-performance-optimization/)

---
**Note Time**：2015.09.29 13:38 Tuesday 上海 慧谷

---

`Blog Url`:<http://qingtianjiedu.com/blog/use-mariadb-date-function-perform-data-grouping/>
`Release Time`:2015-09-29
`BackUpTime`:2015.11.08 15:10